<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Matchmaking</title>
        <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet"
        />

        <style>
            body {
                font-family: Arial, sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                margin: 0;
                padding: 0;
                height: 100vh;
                background-color: #f0f0f0;
            }
            h1 {
                margin-top: 20px;
                font-size: 2rem;
            }
            .button-container,
            .matchmaking-container,
            .private-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 50px;
            }
            .profile-picture,
            .loader {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                background-color: #ddd;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 1.5rem;
                color: #555;
            }
            .loader {
                border: 4px solid #ccc;
                border-top: 4px solid #333;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }
            .vs {
                font-size: 2rem;
                margin: 0 20px;
            }
            .matchmaking-option,
            #codeInput,
            #startButton,
            #copyButton {
                margin-top: 15px;
            }
            #sessionCode {
                margin-top: 15px;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <h1>Choisir le mode de jeu :</h1>
        <div class="button-container">
            <button
                class="w-64 p-4 m-4 bg-green-500 text-white text-xl font-semibold rounded-lg transform transition-transform duration-200 hover:scale-105 hover:bg-green-600"
                onclick="selectMatchmaking()"
            >
                Matchmaking
            </button>
            <button
                class="w-64 py-4 bg-green-500 text-white text-xl font-semibold rounded-lg transform transition-transform duration-200 hover:scale-105 hover:bg-green-600"
                id="button-create-private"
            >
                Créer une partie privée
            </button>
            <input
                type="text"
                id="codeInput"
                placeholder="Entrer le code de partie"
                class="w-64 py-4 border-2 m-4 border-green-500 text-xl rounded-lg focus:outline-none focus:border-green-600 transition duration-200"
            />
            <button
                class="w-64 py-4 bg-green-500 text-white text-xl font-semibold rounded-lg transform transition-transform duration-200 hover:scale-105 hover:bg-green-600"
                onclick="joinPrivateSession()"
            >
                Rejoindre une partie privée
            </button>
        </div>

        <div class="matchmaking-container" style="display: none">
            <h1>Matchmaking en cours</h1>
            <div class="matchmaking-container">
                <div id="hostProfile" class="profile-picture">
                    <img
                        class="profile-picture"
                        src="https://avatar.iran.liara.run/public"
                    />
                </div>
                <div class="vs">VS</div>
                <div id="guestProfile" class="loader"></div>
            </div>
            <button id="startButton" style="display: none">Démarrer</button>
        </div>

        <div class="private-container" style="display: none">
            <h1>Partie Privée</h1>
            <div class="matchmaking-container">
                <div id="hostProfilePrivate" class="profile-picture">
                    <img
                        class="profile-picture"
                        src="https://avatar.iran.liara.run/public"
                    />
                </div>
                <div class="vs">VS</div>
                <div id="guestProfilePrivate" class="loader"></div>
            </div>
            <div id="sessionCode"></div>
            <button id="copyButton" onclick="copySessionCode()">
                Copier le code
            </button>
            <button id="startButtonPrivate" style="display: none">
                Démarrer
            </button>
        </div>

        <!-- Firebase SDK -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
            import {
                getFirestore,
                collection,
                addDoc,
                query,
                where,
                getDocs,
                onSnapshot,
                updateDoc,
                doc,
                getDoc,
            } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
            import {
                getAuth,
                onAuthStateChanged,
            } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

            const firebaseConfig = {
                apiKey: "AIzaSyBSH-hvCVkKhhMrdtfnoqSZ0TZzjmPMulo",
                authDomain: "verdia-4401d.firebaseapp.com",
                projectId: "verdia-4401d",
                storageBucket: "verdia-4401d.firebasestorage.app",
                messagingSenderId: "639552213584",
                appId: "1:639552213584:web:b1ede9db70fc1cceb63755",
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth();

            let userUID;
            let sessionId;
            let quizz;
            let quizzId;

            async function getQuizIdByName(quizName) {
                try {
                    // Référence à la collection "quizzes" (à remplacer par le nom de votre collection)
                    const quizzRef = collection(db, "quizz");

                    // Crée une requête pour trouver le document avec le nom du quiz
                    const q = query(quizzRef, where("quizz", "==", quizName));

                    // Exécute la requête
                    const querySnapshot = await getDocs(q);

                    // Vérifie si le quiz a été trouvé et retourne son ID
                    if (!querySnapshot.empty) {
                        const quizDoc = querySnapshot.docs[0]; // Prend le premier document correspondant
                        const quizId = quizDoc.id;
                        console.log("ID du quiz :", quizId);
                        return quizId;
                    } else {
                        console.log("Quizz introuvable");
                        return null;
                    }
                } catch (error) {
                    console.error(
                        "Erreur lors de la récupération de l'ID du quiz :",
                        error
                    );
                }
            }
            // Fonction pour récupérer le champ `isReady` du document `session`
            async function getIsReady(documentId) {
                try {
                    // Référence au document dans la collection "session"
                    const docRef = doc(db, "session", documentId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        // Récupérer la valeur du champ `isReady`
                        const isReadyP1 = docSnap.data().isReadyP1;
                        const isReadyP2 = docSnap.data().isReadyP2;
                        if (isReadyP1 && isReadyP2) {
                            return true;
                        }
                        console.log("isReady:", isReadyP1, isReadyP2);
                        //return isReady;
                    } else {
                        console.log("Document non trouvé.");
                        return null;
                    }
                } catch (error) {
                    console.error(
                        "Erreur lors de la récupération du champ isReady :",
                        error
                    );
                    return null;
                }
            }

            // Fonction pour vérifier si l'utilisateur est dans la 2e position du tableau 'users'
            async function isUserInSecondPosition(sessionId, userUID) {
                try {
                    // Référence au document 'session' avec l'ID donné
                    const sessionRef = doc(db, "session", sessionId);
                    const sessionSnap = await getDoc(sessionRef);

                    if (sessionSnap.exists()) {
                        const sessionData = sessionSnap.data();

                        // Vérifie que le tableau 'users' a au moins deux éléments
                        if (
                            sessionData.users &&
                            sessionData.users.length >= 2
                        ) {
                            // Vérifie si l'UID de l'utilisateur correspond à celui dans la 2e case (index 1)
                            return sessionData.users[1] === userUID;
                        } else {
                            console.log(
                                "Le tableau 'users' ne contient pas deux éléments."
                            );
                            return false;
                        }
                    } else {
                        console.log("Le document de session n'existe pas.");
                        return false;
                    }
                } catch (error) {
                    console.error(
                        "Erreur lors de la vérification de l'UID dans la 2e position :",
                        error
                    );
                    return false;
                }
            }

            //Listener sur demarrer partie
            document
                .getElementById("startButtonPrivate")
                .addEventListener("click", async function () {
                    quizzId = await getQuizIdByName(quizz);
                    console.log(quizzId + " : " + quizz);
                    //Si c'est le joueur 2, on update a ready
                    let isUser2 = await isUserInSecondPosition(
                        sessionId,
                        userUID
                    );
                    if (isUser2) {
                        updateIsReady(sessionId, "p2", true);
                    }
                    let isReady = false;
                    Swal.fire({
                        title: "Veuillez patienter",
                        text: "Chargement en cours...",
                        allowOutsideClick: false, // Empêche la fermeture en cliquant en dehors de l'alerte
                        didOpen: () => {
                            Swal.showLoading(); // Montre le loader de SweetAlert
                        },
                    });
                    while (!isReady) {
                        isReady = await getIsReady(sessionId);
                        console.log("isReady:", isReady);
                        if (!isReady) {
                            console.log("Waiting for isReady to be true");
                            await new Promise((resolve) =>
                                setTimeout(resolve, 1000)
                            );
                        }
                    }
                    const url = `quiz.html?session=${sessionId}&quizz=${quizzId}`; // Crée l'URL avec le paramètre id
                    window.location.href = url;
                    console.log("redirection to quizz" + sessionId);
                });
            document
                .getElementById("startButton")
                .addEventListener("click", async function () {
                    quizzId = await getQuizIdByName(quizz);
                    console.log(quizzId + " : " + quizz);
                    //Si c'est le joueur 2, on update a ready
                    let isUser2 = await isUserInSecondPosition(
                        sessionId,
                        userUID
                    );
                    if (isUser2) {
                        updateIsReady(sessionId, "p2", true);
                    }
                    let isReady = false;
                    Swal.fire({
                        title: "Veuillez patienter",
                        text: "Chargement en cours...",
                        allowOutsideClick: false, // Empêche la fermeture en cliquant en dehors de l'alerte
                        didOpen: () => {
                            Swal.showLoading(); // Montre le loader de SweetAlert
                        },
                    });
                    while (!isReady) {
                        isReady = await getIsReady(sessionId);
                        console.log("isReady:", isReady);
                        if (!isReady) {
                            console.log("Waiting for isReady to be true");
                            await new Promise((resolve) =>
                                setTimeout(resolve, 1000)
                            );
                        }
                    }
                    const url = `quiz.html?session=${sessionId}&quizz=${quizzId}`;
                    // Crée l'URL avec le paramètre id
                    window.location.href = url;
                    console.log("redirection to quizz:" + sessionId + "id");
                });

            // Choix du matchmaking standard
            function selectMatchmaking() {
                document.querySelector(".button-container").style.display =
                    "none";
                document.querySelector(".matchmaking-container").style.display =
                    "block";
                // Crée un objet URLSearchParams avec les paramètres de l'URL actuelle
                const params = new URLSearchParams(window.location.search);

                // Récupère le paramètre "theme"
                quizz = params.get("quizz");
                findOrCreateSession(quizz);
            }

            window.selectMatchmaking = selectMatchmaking;

            document
                .getElementById("button-create-private")
                .addEventListener("click", function () {
                    // Crée un objet URLSearchParams avec les paramètres de l'URL actuelle
                    const params = new URLSearchParams(window.location.search);

                    // Récupère le paramètre "theme"
                    quizz = params.get("quizz");
                    createPrivateSession(quizz);
                });

            // Créer une partie privée
            async function createPrivateSession(quizz) {
                document.querySelector(".button-container").style.display =
                    "none";
                document.querySelector(".private-container").style.display =
                    "block";
                let newSessionDoc;
                if (userUID) {
                    newSessionDoc = await addDoc(collection(db, "session"), {
                        date_creation: Date.now(),
                        gagnant: "",
                        quizz: quizz,
                        score: [0, 0],
                        users: [userUID, "privé"], // users est maintenant un tableau
                        isReadyP1: true,
                        isReadyP2: false,
                    });
                    sessionId = newSessionDoc.id;
                }

                document.getElementById(
                    "sessionCode"
                ).innerText = `Code de session: ${sessionId}`;
                watchSessionChanges(newSessionDoc, "private");
            }
            window.createPrivateSession = createPrivateSession;

            // Rejoindre une partie privée via code
            async function joinPrivateSession() {
                // Crée un objet URLSearchParams avec les paramètres de l'URL actuelle
                const params = new URLSearchParams(window.location.search);

                // Récupère le paramètre "theme"
                quizz = params.get("quizz");
                const code = document.getElementById("codeInput").value;

                if (code === "") {
                    Swal.fire({
                        icon: "error",
                        title: "Veuillez entrer un code de session !",
                    });
                    return;
                }
                const sessionRef = doc(db, "session", code);
                const sessionSnap = await getDoc(sessionRef);

                if (
                    sessionSnap.exists() &&
                    sessionSnap.data().users[1] === "privé"
                ) {
                    console.log("check");

                    // Mise à jour de l'utilisateur 1 dans la session
                    const sessionDoc = sessionSnap;

                    sessionId = code;
                    const sessionData = sessionDoc.data();
                    const users = sessionData.users;

                    // Ajoute le nouvel utilisateur à l'index 1 du tableau users
                    users[1] = userUID;

                    // Mise à jour de la session avec les deux utilisateurs
                    await updateDoc(sessionDoc.ref, {
                        users: users,
                    });
                    //await updateDoc(sessionRef, { "users.1": userUID }); // Modification de l'utilisateur 1
                    //sessionId = code;

                    //guest trouvé modif du css
                    document.querySelector(".button-container").style.display =
                        "none";
                    document.querySelector(".private-container").style.display =
                        "block";
                    document.getElementById(
                        "sessionCode"
                    ).innerText = `Code de session: ${sessionId}`;
                    //on fait disparaitre le loader
                    document
                        .getElementById("guestProfilePrivate")
                        .classList.remove("loader");
                    document.getElementById(
                        "guestProfilePrivate"
                    ).innerHTML = `<img src="https://avatar.iran.liara.run/public" alt="Guest Profile" style="width: 100px; height: 100px; border-radius: 50%;">`;
                    document.getElementById(
                        "startButtonPrivate"
                    ).style.display = "block";
                    updateIsReady(sessionId, "p1", true);
                } else {
                    alert("Session privée introuvable ou déjà remplie !");
                }
            }
            window.joinPrivateSession = joinPrivateSession;

            // Fonction pour mettre à jour le champ 'isReady'
            async function updateIsReady(sessionId, player, isReadyValue) {
                try {
                    // Référence du document à mettre à jour dans la collection "session"
                    const sessionRef = doc(db, "session", sessionId);

                    if (player == "p1") {
                        await updateDoc(sessionRef, {
                            isReadyP1: isReadyValue,
                        });
                    } else {
                        await updateDoc(sessionRef, {
                            isReadyP2: isReadyValue,
                        });
                    }
                    // Mise à jour du champ 'isReady' dans le document

                    console.log(
                        "Le champ isReady a été mis à jour avec succès."
                    );
                } catch (error) {
                    console.error(
                        "Erreur lors de la mise à jour du champ isReady :",
                        error
                    );
                }
            }
            async function findOrCreateSession(quizz) {
                console.log(quizz + " quizz");
                console.log(userUID + " userUID");
                const sessionRef = collection(db, "session");

                // Rechercher des sessions où l'index 1 est null
                const sessionQuery = query(
                    sessionRef,
                    where("quizz", "==", quizz)
                );
                const sessionSnapshot = await getDocs(sessionQuery);

                let foundSession = null;
                sessionSnapshot.forEach((doc) => {
                    const sessionData = doc.data();
                    if (sessionData.users[1] === null) {
                        foundSession = doc;
                    }
                });

                if (foundSession) {
                    // Si une session est trouvée, on récupère l'utilisateur 0 et on ajoute l'utilisateur 1
                    const sessionDoc = foundSession;
                    sessionId = sessionDoc.id;
                    console.log(sessionId + "foundsession");
                    const sessionData = sessionDoc.data();
                    const users = sessionData.users;

                    // Ajoute le nouvel utilisateur à l'index 1 du tableau users
                    users[1] = userUID;

                    // Mise à jour de la session avec les deux utilisateurs
                    await updateDoc(sessionDoc.ref, {
                        users: users,
                    });

                    // Suivre les changements pour afficher le profil de l'autre utilisateur
                    watchSessionChanges(sessionDoc.ref);
                } else {
                    // Créer une nouvelle session si aucune n'est trouvée
                    const newSessionDoc = await addDoc(sessionRef, {
                        date_creation: Date.now(),
                        gagnant: "",
                        quizz: quizz,
                        score: [0, 0],
                        users: [userUID, null], // Crée une session avec un utilisateur à l'index 0 et un libre à l'index 1
                        isReadyP1: true,
                        isReadyP2: false,
                    });
                    sessionId = newSessionDoc.id;
                    console.log(sessionId + "creation");
                    // Suivre les changements pour détecter l'arrivée d'un autre utilisateur
                    watchSessionChanges(newSessionDoc);
                }
            }

            // Fonction pour surveiller les changements dans la session
            function watchSessionChanges(sessionDocRef, mode) {
                onSnapshot(sessionDocRef, (doc) => {
                    const sessionData = doc.data();
                    const guestProfile =
                        mode === "private"
                            ? "guestProfilePrivate"
                            : "guestProfile";
                    const startButton =
                        mode === "private"
                            ? "startButtonPrivate"
                            : "startButton";

                    if (
                        sessionData.users[1] &&
                        sessionData.users[1] !== "privé"
                    ) {
                        //on fait disparaitre le loader
                        document
                            .getElementById(guestProfile)
                            .classList.remove("loader");
                        document.getElementById(
                            guestProfile
                        ).innerHTML = `<img src="https://avatar.iran.liara.run/public" alt="Guest Profile" style="width: 100px; height: 100px; border-radius: 50%;">`;
                        document.getElementById(startButton).style.display =
                            "block";
                    }
                });
            }

            // Copier le code de session
            function copySessionCode() {
                navigator.clipboard.writeText(sessionId).then(() => {
                    alert("Code de session copié !");
                });
            }
            window.copySessionCode = copySessionCode;

            // Authentification de l'utilisateur
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userUID = user.uid;
                } else {
                    console.error("Erreur d'authentification");
                }
            });

            // Connexion anonyme pour simplifier
            auth.signInAnonymously();
        </script>
    </body>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</html>
