<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #f3f9f1;
    }

    .chat-overlay {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background-color: #e0f5e8;
      border-radius: 8px;
    }

    .chat-header {
      background: #4CAF50;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 16px;
    }

    .chat-list, .chat-window {
      overflow-y: auto;
      flex-grow: 1;
      padding: 10px;
    }

    .chat-list {
      display: block;
      max-height: 160px;
      overflow-y: auto;
    }

    .chat-list h2 {
      text-align: center;
      color: #2b6d5d;
      margin-bottom: 8px;
    }

    .chat-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .chat-list ul li {
      padding: 8px;
      background-color: #f8fffb;
      margin-bottom: 5px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 14px;
    }

    .chat-list ul li:hover, .chat-list ul li.selected {
      background-color: #b8dec3;
    }

    .chat-window {
      display: none;
      flex-direction: column;
      max-height: 230px;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 10px;
    }

    .sent, .received {
      padding: 8px;
      border-radius: 5px;
      max-width: 70%;
      margin: 5px 0;
    }

    .sent {
      background-color: #a1cba7;
      align-self: flex-end;
      color: #fff;
    }

    .received {
      background-color: #f0faf3;
      color: #2b6d5d;
      align-self: flex-start;
    }

    .chat-controls {
      display: flex;
      align-items: center;
    }

    #messageInput {
      width: 75%;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 5px;
      font-size: 14px;
    }

    #sendMessage {
      padding: 5px 10px;
      background-color: #2b6d5d;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    #sendMessage:hover {
      background-color: #24584c;
    }

    #newConversationButton {
      padding: 8px;
      background-color: #2b6d5d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-size: 14px;
      margin-top: 8px;
    }

    #friendListPanel {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #e0f5e8;
      border-radius: 8px;
      padding: 10px;
      width: 90%;
      max-width: 250px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    #friendListPanel h3 {
      text-align: center;
      color: #2b6d5d;
      font-size: 14px;
    }

    #friendListPanel ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #friendListPanel ul li {
      padding: 8px;
      background-color: #f8fffb;
      margin-bottom: 5px;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    #friendListPanel ul li:hover {
      background-color: #b8dec3;
    }
  </style>
</head>
<body>
  <div class="chat-overlay">
    <div class="chat-header">Chat</div>
    <div class="chat-list" id="chatList">
      <h2>Conversations</h2>
      <ul id="conversations"></ul>
      <button id="newConversationButton">Nouvelle Conversation</button>
    </div>

    <div class="chat-window" id="chatWindow">
      <div id="messages"></div>
      <div class="chat-controls">
        <input type="text" id="messageInput" placeholder="Tapez un message...">
        <button id="sendMessage">Envoyer</button>
        <button onclick="showChatList()">Retour</button>
      </div>
    </div>
  </div>

  <div id="friendListPanel">
    <h3>Choisissez un ami</h3>
    <ul id="friendList"></ul>
    <button onclick="closeFriendListPanel()">Fermer</button>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, onSnapshot, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyBSH-hvCVkKhhMrdtfnoqSZ0TZzjmPMulo",
      authDomain: "verdia-4401d.firebaseapp.com",
      projectId: "verdia-4401d",
      storageBucket: "verdia-4401d.firebasestorage.app",
      messagingSenderId: "639552213584",
      appId: "1:639552213584:web:b1ede9db70fc1cceb63755"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
  
    let currentUser;
    let selectedChatId = null;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loadConversations();
      } else {
        console.log("L'utilisateur n'est pas connecté");
      }
    });
  
    async function loadConversations() {
      const chatList = document.getElementById("conversations");
      chatList.innerHTML = "";

      const q = query(collection(db, "chat"), where("users", "array-contains", currentUser.uid));
      const querySnapshot = await getDocs(q);

      for (const documentSnapshot of querySnapshot.docs) {
        const chatData = documentSnapshot.data();
        const chatId = documentSnapshot.id;
        const otherUserId = chatData.users.find(uid => uid !== currentUser.uid);

        const userDoc = await getDoc(doc(db, "users", otherUserId));
        const username = userDoc.exists() ? userDoc.data().username : "Inconnu";
        const lastMessage = chatData.lastMessage || "";

        const conversation = document.createElement("li");
        conversation.id = chatId;
        conversation.innerHTML = `<strong>${username}</strong><br><span>${lastMessage}</span>`;
        conversation.onclick = () => {
          selectConversation(chatId);
          loadMessages(chatId);
        };
        chatList.appendChild(conversation);
      }
    }

    function selectConversation(chatId) {
      selectedChatId = chatId;
      document.getElementById("chatList").style.display = "none";
      document.getElementById("chatWindow").style.display = "flex"; // Affiche la fenêtre de chat
      const conversations = document.querySelectorAll("#conversations li");
      conversations.forEach((li) => li.classList.remove("selected"));
      document.getElementById(chatId).classList.add("selected");
    }

    function showChatList() {
      document.getElementById("chatList").style.display = "block";
      document.getElementById("chatWindow").style.display = "none";
    }
  
    async function loadMessages(chatId) {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
  
      const q = query(collection(db, "chat", chatId, "messages"), orderBy("timestamp"));
      onSnapshot(q, async (snapshot) => {
        messagesDiv.innerHTML = "";
        
        for (const docSnapshot of snapshot.docs) {
          const message = docSnapshot.data();
          
          // Récupérer le pseudo de l'envoyeur
          const senderDoc = await getDoc(doc(db, "users", message.senderUid));
          const senderUsername = senderDoc.exists() ? senderDoc.data().username : "Inconnu";

          const messageElement = document.createElement("div");
          messageElement.className = message.senderUid === currentUser.uid ? "sent" : "received";
          messageElement.innerHTML = `<strong>${senderUsername}:</strong> ${message.content}`;
          messagesDiv.appendChild(messageElement);
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll automatique vers le bas
      });
    }
  
    document.getElementById("sendMessage").onclick = async () => {
      const messageInput = document.getElementById("messageInput");
      const messageContent = messageInput.value;
  
      if (messageContent && selectedChatId) {
        await addDoc(collection(db, "chat", selectedChatId, "messages"), {
          senderUid: currentUser.uid,
          content: messageContent,
          timestamp: Date.now()
        });

        await updateDoc(doc(db, "chat", selectedChatId), {
          lastMessage: messageContent
        });

        messageInput.value = "";
      }
    };
  
    async function loadFriends() {
      const friendList = document.getElementById("friendList");
      friendList.innerHTML = "";
  
      const friendsCollection = collection(db, "users", currentUser.uid, "Friends");
      const friendsSnapshot = await getDocs(friendsCollection);
  
      friendsSnapshot.forEach((friendDoc) => {
        const friendData = friendDoc.data();
        const friendUid = friendDoc.id;
        const friendUsername = friendData.username || "Inconnu";
  
        const friendItem = document.createElement("li");
        friendItem.innerText = friendUsername;
        friendItem.onclick = () => startChatWithFriend(friendUid);
        friendList.appendChild(friendItem);
      });
    }
    
    function openFriendListPanel() {
      loadFriends();
      document.getElementById("friendListPanel").style.display = "block";
    }
    window.openFriendListPanel =  openFriendListPanel;

    function closeFriendListPanel() {
      document.getElementById("friendListPanel").style.display = "none";
    }
    window.closeFriendListPanel = closeFriendListPanel;

    async function startChatWithFriend(friendUid) {
      const existingConversation = await getDocs(query(collection(db, "chat"), where("users", "array-contains", currentUser.uid)));
      let conversationExists = false;
  
      existingConversation.forEach((doc) => {
        if (doc.data().users.includes(friendUid)) {
          conversationExists = true;
          selectConversation(doc.id);
          loadMessages(doc.id);
        }
      });
  
      if (!conversationExists) {
        const newChatRef = await addDoc(collection(db, "chat"), { users: [currentUser.uid, friendUid], lastMessage: "" });
        selectConversation(newChatRef.id);
        loadMessages(newChatRef.id);
      }
  
      closeFriendListPanel();
    }
    
    document.getElementById("newConversationButton").onclick = openFriendListPanel;

  </script>
</body>
</html>